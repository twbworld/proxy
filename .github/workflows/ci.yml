name: ci
on:
  workflow_dispatch: #github页面手动触发
  push: #push即触发
    branches:
      - master
    paths-ignore: #不作为触发的文件
      - '.*'
      - 'LICENSE'
      - 'README.md'
jobs:
  unit-test:
    runs-on: ubuntu-20.04 #虚拟环境(github提供)
    steps:
      - uses: actions/checkout@v2
      - uses: php-actions/composer@v5
      - name: restart-mysql #该ubuntu-20.04自带mysql8.0
        run: sudo systemctl restart mysql
      - name: create-db
        run: sudo mysqladmin -uroot -proot create trojan
      - name: save-data
        run: sudo mysql -uroot -proot trojan < src/data/users.sql
      - name: add-envFile
        run: sudo echo '${{secrets.TEST_ENV}}' > src/config/.env
      - name: ln-php7.4 #该ubuntu-20.04自带php8.0/7.4,php命令默认8.0,这里ln成7.4的
        run: |
          sudo ln -sf /bin/php7.4 /bin/php
          sudo ln -sf /usr/bin/php7.4 /usr/bin/php
      - name: phpunit-test
        run: sudo XDEBUG_MODE=coverage ./vendor/bin/phpunit #如果不设置XDEBUG_MODE,coverage.xml文件会导不出
      - name: Up-Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{secrets.CODECOV_TOKEN}}
          file: ./tests/report/coverage.xml
          directory: ./tests/report/
          fail_ci_if_error: true #出错暂停
          verbose: true #列出详情
      # - uses: php-actions/phpunit@v2
      #   with:
      #     configuration: ./phpunit.xml
      #     version: 9.5.2
      #     php_version: 7.4
      #     php_extensions: xdebug mbstring mysqli pdo_mysql
  repo-pull:
    runs-on: ubuntu-20.04
    steps:
      - uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /var/www/proxy/
            git checkout -- .
            git checkout master
            git fetch origin master
            git merge origin/master
